<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin – EMpaticos</title>
  <link rel="stylesheet" href="css/styles.css">
</head>
<body>
  <header class="header-fixed">
    <div class="container flex">
      <img src="./images/LogoEMpaticos2.jpg" alt="EMpaticos" class="logo">
      <span class="header-title">EMpaticos</span>
      <nav>
        <ul class="menu flex">
          <li><a href="index.html">Home</a></li>
          <li><a href="noticias.html">Noticias</a></li>
          <li><a href="unirme.html">Unirme</a></li>
          <li><a href="historias.html">Historias</a></li>
          <li><a href="nosotros.html">Nosotros</a></li>
        </ul>
      </nav>
    </div>
  </header>

  <main class="container">
    <h1>Panel Admin – EMpaticos</h1>

    <div id="login-section">
      <p>Ingresa la contraseña para acceder:</p>
      <input type="password" id="admin-password" placeholder="Contraseña" />
      <button onclick="login()">Entrar</button>
    </div>

    <div id="admin-panel" style="display:none;">
      <button onclick="logout()">Cerrar sesión</button>
      <button onclick="loadStories()" class="btn" style="margin-left:20px;">Recargar historias</button>
      <h2>Historias pendientes de aprobación</h2>
      <div id="stories-list"></div>
    </div>
  </main>

  <footer class="footer">
    <div class="container">
      <p>EMpaticos © 2025 – No estás solo ❤️</p>
    </div>
  </footer>

  <script>
    const API_URL = "http://localhost:5000/api"; // Backend local

    const ADMIN_PASSWORD = "EMpaticos2025arg"; // Contraseña segura

    function login() {
      const pass = document.getElementById('admin-password').value;
      if (pass === ADMIN_PASSWORD) {
        document.getElementById('login-section').style.display = 'none';
        document.getElementById('admin-panel').style.display = 'block';
        loadStories();
      } else {
        alert("Contraseña incorrecta ❤️");
      }
    }

    function logout() {
      document.getElementById('login-section').style.display = 'block';
      document.getElementById('admin-panel').style.display = 'none';
      document.getElementById('admin-password').value = '';
    }

    async function loadStories() {
      try {
        const res = await fetch(`${API_URL}/stories/all`);
        if (!res.ok) throw new Error('Backend no responde');
        const stories = await res.json();

        const list = document.getElementById('stories-list');
        list.innerHTML = '';

        if (stories.length === 0) {
          list.innerHTML = '<p>No hay historias pendientes.</p>';
          return;
        }

        stories.forEach(story => {
          const div = document.createElement('div');
          div.className = 'card-noticia';
          div.innerHTML = `
            <p><strong>Nombre:</strong> ${story.nombre || 'Anónimo'}</p>
            <p><strong>Tipo EM:</strong> ${story.tipoEM || 'No especificado'}</p>
            <p><strong>Historia:</strong> ${story.historia}</p>
            <p><strong>Fecha:</strong> ${new Date(story.createdAt).toLocaleDateString()}</p>
            <p><strong>Estado:</strong> ${story.approved ? 'Aprobada' : 'Pendiente'}</p>
            ${!story.approved ? `
              <button onclick="approveStory(${story.id})" class="btn">Aprobar</button>
              <button onclick="rejectStory(${story.id})" style="background:red; color:white; margin-left:10px;">Rechazar y borrar</button>
            ` : '<em>Ya aprobada</em>'}
          `;
          list.appendChild(div);
        });
      } catch (err) {
        document.getElementById('stories-list').innerHTML = '<p>Error: Backend no está corriendo. Corré node index.js.</p>';
      }
    }

    async function approveStory(id) {
      try {
        const res = await fetch(`${API_URL}/stories/${id}/approve`, { method: 'PATCH' });
        if (!res.ok) throw new Error();
        loadStories();
      } catch (err) {
        alert("Error aprobando. Verificá backend.");
        loadStories();
      }
    }

    async function rejectStory(id) {
      if (confirm("¿Seguro que querés rechazar y BORRAR esta historia permanentemente?")) {
        try {
          const res = await fetch(`${API_URL}/stories/${id}`, { method: 'DELETE' });
          if (!res.ok) throw new Error();
          loadStories();
        } catch (err) {
          alert("Error borrando. Verificá backend.");
          loadStories();
        }
      }
    }
  </script>
</body>
</html>